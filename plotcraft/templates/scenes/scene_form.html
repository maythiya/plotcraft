{% extends "base.html" %}
{% block content %}
<script src="https://cdn.tailwindcss.com"></script>

<div class="min-h-screen py-8 px-4 font-sans text-[#2F4F4F]">
    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-2xl p-8 border border-[#2F4F4F]/10 relative">
        <div class="absolute top-0 left-0 w-full h-1.5 bg-linear-to-r from-[#2F4F4F] to-[#DAA520]"></div>

        <h1 class="text-2xl font-bold mb-6 flex items-center gap-2">
            <span class="text-[#DAA520]">üé¨</span> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏â‡∏≤‡∏Å (Scene Editor)
        </h1>

        <form method="post">
            {% csrf_token %}
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block font-bold text-sm mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏â‡∏≤‡∏Å *</label>
                    {{ form.title }}
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="block font-bold text-sm mb-1">‡∏•‡∏≥‡∏î‡∏±‡∏ö (Order)</label>
                        {{ form.order }}
                    </div>
                    <div>
                        <label class="block font-bold text-sm mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                        {{ form.status }}
                    </div>
                </div>
                <div class="md:col-span-2">
                    <label class="block font-bold text-sm mb-1">‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á (Project)</label>
                                
                    {% if scene %}
                        {{ form.project }}
                    {% else %}
                        <select name="project" 
                                onchange="if(this.value) window.location.href='?project=' + this.value"
                                class="w-full px-4 py-2 bg-white border border-[#FAEBD7] rounded-lg focus:ring-2 focus:ring-[#DAA520] outline-none transition">
                            <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢ --</option>
                            {% for novel in form.fields.project.queryset %}
                                <option value="{{ novel.id }}" 
                                    {% if form.initial.project.id == novel.id or request.GET.project|add:"0" == novel.id %}selected{% endif %}>
                                    {{ novel.title }}
                                </option>
                            {% endfor %}
                        </select>
                    {% endif %}
                </div>
            </div>

            <hr class="border-[#FAEBD7] my-6">

            <h3 class="font-bold text-lg text-[#2F4F4F] mb-3">‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏â‡∏≤‡∏Å</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block font-bold text-sm mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (Location)</label>
                    {{ form.location }}
                </div>
                <div>
                    <label class="block font-bold text-sm mb-1">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (POV)</label>
                    {{ form.pov_character }}
                </div>
                <div>
                    <label class="block font-bold text-sm mb-1">‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÉ‡∏ô‡∏â‡∏≤‡∏Å</label>
                    {{ form.characters }}
                </div>
                <div>
                    <label class="block font-bold text-sm mb-1">‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</label>
                    {{ form.items }}
                </div>
            </div>

            <hr class="border-[#FAEBD7] my-6">

            <h3 class="font-bold text-lg text-[#2F4F4F] mb-3">‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</h3>
            <div class="space-y-4 mb-6">
                <div>
                    <label class="block font-bold text-sm mb-1 text-blue-800">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (Goal)</label>
                    {{ form.goal }}
                </div>
                <div>
                    <label class="block font-bold text-sm mb-1 text-red-800">‡∏≠‡∏∏‡∏õ‡∏™‡∏£‡∏£‡∏Ñ (Conflict)</label>
                    {{ form.conflict }}
                </div>
                <div>
                    <label class="block font-bold text-sm mb-1 text-green-800">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (Outcome)</label>
                    {{ form.outcome }}
                </div>
            </div>

            <div class="mb-8">
                <label class="block font-bold text-sm mb-1">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ / ‡∏ö‡∏ó‡∏£‡πà‡∏≤‡∏á</label>
                {{ form.content }}
            </div>

            <div class="mb-6 p-4 bg-purple-50 rounded-xl border border-purple-200">
                <h3 class="font-bold text-purple-800 mb-2">‚ú® ‡πÉ‡∏´‡πâ AI ‡∏ä‡πà‡∏ß‡∏¢‡∏£‡πà‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏â‡∏≤‡∏Å</h3>
                <div class="flex gap-2">
                    <input type="text" id="ai-scene-concept" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:border-purple-500" 
                           placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏û‡∏£‡∏∞‡πÄ‡∏≠‡∏Å‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏ñ‡πâ‡∏≥‡∏°‡∏±‡∏á‡∏Å‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ß ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡∏•‡πâ‡∏á‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏Å‡πà‡∏á">
                    <button type="button" onclick="generateSceneContent()" 
                            class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 font-bold whitespace-nowrap shadow-sm transition">
                        üîÆ ‡πÄ‡∏™‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤
                    </button>
                </div>
                <p id="ai-loading" class="text-sm text-gray-500 mt-2 hidden items-center gap-2">
                    <svg class="animate-spin h-4 w-4 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡πà‡∏≤‡∏¢‡πÄ‡∏ß‡∏ó‡∏°‡∏ô‡∏ï‡∏£‡πå‡∏£‡πà‡∏≤‡∏á‡∏â‡∏≤‡∏Å...
                </p>
                <p id="ai-error" class="text-sm text-red-500 mt-2 hidden"></p>
            </div>

            <div class="flex gap-3 pt-4 border-t border-[#FAEBD7]">
                <button type="submit" class="bg-[#2F4F4F] text-white px-6 py-2 rounded-lg font-bold hover:bg-[#1a3030] shadow-md transition">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏â‡∏≤‡∏Å
                </button>
                <a href="{% url 'plotcraft:scene_list' %}" class="border border-gray-300 px-6 py-2 rounded-lg hover:bg-gray-50 text-gray-600 font-medium transition">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </a>
                
                {% if scene %}
                <button type="submit" name="scene_delete" class="ml-auto text-red-600 hover:text-red-800 text-sm font-bold bg-red-50 px-4 py-2 rounded-lg hover:bg-red-100 transition" onclick="return confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏â‡∏≤‡∏Å‡∏ô‡∏µ‡πâ?');">
                    ‡∏•‡∏ö‡∏â‡∏≤‡∏Å
                </button>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<script>
    function generateSceneContent() {
        const conceptInput = document.getElementById('ai-scene-concept');
        const concept = conceptInput.value.trim();
        const loadingText = document.getElementById('ai-loading');
        const errorText = document.getElementById('ai-error');
        // ‡∏´‡∏≤ field content (Django ‡∏°‡∏±‡∏Å‡∏à‡∏∞‡πÉ‡∏ä‡πâ id_content)
        const contentField = document.getElementById('id_content') || document.querySelector('textarea[name="content"]');

        if (!concept) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏Ç‡∏≠‡∏á‡∏â‡∏≤‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏£‡πà‡∏≤‡∏¢‡πÄ‡∏ß‡∏ó‡∏°‡∏ô‡∏ï‡∏£‡πå!");
            return;
        }

        loadingText.classList.remove('hidden');
        errorText.classList.add('hidden');

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API (‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ endpoint ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà)
        // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡πÄ‡∏û‡∏¥‡πà‡∏° logic ‡∏ù‡∏±‡πà‡∏á backend ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡∏ô‡∏â‡∏≤‡∏Å
        fetch("{% url 'plotcraft:ai_generate_scene' %}", { // ‚ö†Ô∏è ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô urls.py ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ concept: concept })
        })
        .then(response => response.json())
        .then(data => {
            loadingText.classList.add('hidden');
            if (data.success) {
                // ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏•‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á Content
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà
                const currentContent = contentField.value;
                const newContent = data.data.content || data.data; // ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏±‡∏ö structure ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö
                
                if(currentContent) {
                    contentField.value = currentContent + "\n\n" + newContent;
                } else {
                    contentField.value = newContent;
                }
                
                // ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
                conceptInput.value = ''; 
                alert("‚ú® ‡∏£‡πà‡∏≤‡∏á‡∏â‡∏≤‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
            } else {
                errorText.textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + (data.error || "AI ‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á");
                errorText.classList.remove('hidden');
            }
        })
        .catch(err => {
            loadingText.classList.add('hidden');
            errorText.textContent = "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + err;
            errorText.classList.remove('hidden');
            console.error(err);
        });
    }
</script>
{% endblock %}